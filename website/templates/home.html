{% extends 'base.html' %}

{% block content %}

{% if user.is_authenticated %}
  <h1>Records</h1>
  <button id="deleteSelected" class="btn btn-danger mb-3">Delete Selected</button>

  <table id="recordsTable" class="table table-striped table-hover table-bordered table-sm ">
    <thead class="table-dark">
      <tr>
        <th><input type="checkbox" id="selectAll"></th>
        <th>Name</th>
        <th>Gender</th>
        <th>National_ID</th>
        <th>Marital_Status</th>
        <th>Fullname_Spouse</th>
        <th>Email</th>
        <th>DOB</th>
        <th>Phone_main</th>
        <th>Phone_optional</th>
        <th>Address</th>
        <th>Province</th>
        <!--th>Creation_Date</th-->
        <th>ID</th>
      </tr>
    </thead>
   <tbody>
  {% if records %}
    {% for record in records %}
    <tr>
      <!-- First column: only checkbox -->
      <td>
        <input type="checkbox" class="record-checkbox" value="{{ record.id }}">
      </td>

      <!-- Second column: Name link -->
      <td>
        <a href="{% url 'record' record.id %}">
          {{ record.first_name }} {{ record.last_name }}
        </a>
      </td>

      <td>{{ record.gender }}</td>
      <td>{{ record.national_id }}</td>
      <td>{{ record.marital_status }}</td>
      <td>{{ record.fullname_spouse }}</td>
      <td>{{ record.email }}</td>
      <td>{{ record.dob }}</td>
      <td>{{ record.phone_main }}</td>
      <td>{{ record.phone_optional }}</td>
      <td>{{ record.address }}</td>
      <td>{{ record.province }}</td>
      <!--td>{{ record.creation_date }}</td-->
      <td>
        <a href="{% url 'record' record.id %}">{{ record.id }}</a>
      </td>
    </tr>
    {% endfor %}
  {% endif %}
</tbody>

  </table>

{% else %}
  <div class="col-md-6 offset-md-3">
    <h1>Login</h1>
    <br/>
    <form method="POST" action="{% url 'home' %}">
      {% csrf_token %}
      <div class="mb-3">
        <input type="text" class="form-control" name="username" placeholder="Username" required>
      </div>
      <div class="mb-3">
        <input type="password" class="form-control" name="password" placeholder="Password" required>
      </div>
      <button type="submit" class="btn btn-secondary">Login</button>
    </form>
  </div>
{% endif %}

{% endblock %}


{% block scripts %}
<script>
$(document).ready(function() {
    var table = $('#recordsTable').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'print',
                exportOptions: { columns: ':not(:first-child)' } // exclude checkbox col
            },
            {
                extend: 'excelHtml5',
                exportOptions: { columns: ':not(:first-child)' }
            },
            {
                extend: 'pdfHtml5',
                exportOptions: { columns: ':not(:first-child)' }
            }
        ],
        pageLength: 10,
        columnDefs: [
            { orderable: false, targets: 0 } // disable ordering on checkbox column
        ]
    });

    // Select/Deselect All
    $('#selectAll').on('click', function(){
        $('.record-checkbox').prop('checked', this.checked);
    });

    // Delete Selected
    $('#deleteSelected').on('click', function(){
        var ids = [];
        $('.record-checkbox:checked').each(function(){
            ids.push($(this).val());
        });

        if(ids.length === 0){
            alert("Please select at least one record to delete.");
            return;
        }

        if(confirm("Are you sure you want to delete selected records?")){
            $.ajax({
                url: "{% url 'delete_records' %}",
                type: "POST",
                data: {
                    'ids[]': ids,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response){
                    $('.record-checkbox:checked').each(function(){
                        table.row($(this).closest('tr')).remove().draw();
                    });
                    alert(response.message);
                }
            });
        }
    });
});
</script>
{% endblock %}
